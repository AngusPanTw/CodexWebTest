<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°è‚¡å‰µæ–°é«˜/ä½æ¯”è¼ƒæŸ¥çœ‹å™¨ (é›¢ç·šç‰ˆ)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    .controls {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-width: 120px;
    }
    label {
      font-weight: bold;
      color: #555;
      font-size: 13px;
    }
    select, input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    select:focus, input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0,123,255,.25);
    }
    .stats {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      font-weight: bold;
    }
    table { 
      border-collapse: collapse; 
      width: 100%;
      margin-top: 10px;
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 8px;
      text-align: left;
    }    th {
      background-color: #007bff;
      color: white;
      font-weight: bold;
      position: sticky;
      top: 0;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s;
    }
    th:hover {
      background-color: #0056b3;
    }
    th.sortable::after {
      content: ' â†•ï¸';
      font-size: 12px;
      opacity: 0.6;
    }
    th.sort-asc::after {
      content: ' â†‘';
      font-size: 14px;
      opacity: 1;
    }
    th.sort-desc::after {
      content: ' â†“';
      font-size: 14px;
      opacity: 1;
    }
    tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    tbody tr:hover {
      background-color: #e3f2fd;
    }
    .high-row {
      border-left: 4px solid #28a745;
    }
    .low-row {
      border-left: 4px solid #dc3545;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .file-input {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 5px;
    }
    .file-input input[type="file"] {
      margin-left: 10px;
    }
    .note {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>å°è‚¡å‰µæ–°é«˜/ä½æ¯”è¼ƒæŸ¥çœ‹å™¨ (é›¢ç·šç‰ˆ)</h1>
      <div class="note">
      <strong>ğŸ“‹ ä½¿ç”¨èªªæ˜ï¼š</strong> 
      æ­¤ç‰ˆæœ¬ä¸éœ€è¦æœ¬åœ°ä¼ºæœå™¨ã€‚è«‹é¸æ“‡å°æ‡‰çš„ JSON æª”æ¡ˆä¾†è¼‰å…¥è³‡æ–™ã€‚<br>
      <strong>ğŸ“… æ—¥æœŸèªªæ˜ï¼š</strong>
      <ul style="margin: 10px 0; padding-left: 20px;">
        <li><strong>åŸºæº–æœŸé–“ï¼š</strong> 2025-04-07 è‡³ 2025-05-25ï¼ˆåŸºæº–é«˜/ä½åƒ¹çš„çµ±è¨ˆæœŸé–“ï¼‰</li>
        <li><strong>æ¯”è¼ƒæœŸé–“ï¼š</strong> 2025-05-26 è‡³ 2025-06-20ï¼ˆå‰µæ–°é«˜/ä½ç™¼ç”ŸæœŸé–“ï¼‰</li>
        <li><strong>åŸºæº–åƒ¹ï¼š</strong> åŸºæº–æœŸé–“å…§è©²è‚¡ç¥¨çš„æœ€é«˜/æœ€ä½åƒ¹</li>
        <li><strong>æ–°é«˜/æ–°ä½ï¼š</strong> åœ¨æ¯”è¼ƒæœŸé–“çªç ´åŸºæº–åƒ¹çš„ç•¶æ—¥æœ€é«˜/æœ€ä½åƒ¹</li>
      </ul>
    </div>
    
    <div class="file-input">
      <label for="highFileInput">è¼‰å…¥å‰µæ–°é«˜æ¯”è¼ƒè³‡æ–™:</label>
      <input type="file" id="highFileInput" accept=".json" />
      
      <label for="lowFileInput" style="margin-left: 20px;">è¼‰å…¥å‰µæ–°ä½æ¯”è¼ƒè³‡æ–™:</label>
      <input type="file" id="lowFileInput" accept=".json" />
    </div>
    
    <div class="controls">
      <div class="control-group">
        <label for="typeSelect">è³‡æ–™é¡å‹:</label>
        <select id="typeSelect">
          <option value="high">å‰µæ–°é«˜</option>
          <option value="low">å‰µæ–°ä½</option>
        </select>
      </div>
        <div class="control-group">
        <label for="dateInput">ç¯©é¸å‰µæ–°æ—¥æœŸ:</label>
        <input type="date" id="dateInput" title="ç¯©é¸ç‰¹å®šæ—¥æœŸå‰µå‡ºæ–°é«˜/æ–°ä½çš„è‚¡ç¥¨">
      </div>      <div class="control-group">
        <label for="stockInput">è‚¡ç¥¨ä»£è™Ÿ/åç¨±:</label>
        <input type="text" id="stockInput" placeholder="è¼¸å…¥ä»£è™Ÿæˆ–åç¨±æœå°‹">
      </div>
      
      <button onclick="clearFilters()">æ¸…é™¤ç¯©é¸</button>
    </div>
    
    <div id="stats" class="stats">è«‹è¼‰å…¥è³‡æ–™æª”æ¡ˆ</div>    <table id="resultTable">
      <thead>
        <tr>
          <th class="sortable" data-sort="code">ä»£è™Ÿ</th>
          <th class="sortable" data-sort="name">åç¨±</th>
          <th class="sortable sort-desc" data-sort="date">å‰µæ–°æ—¥æœŸ</th>
          <th class="sortable" data-sort="close">æ”¶ç›¤åƒ¹</th>
          <th id="basePriceHeader" class="sortable" data-sort="base">åŸºæº–åƒ¹<br><small>(2025/04/07-05/25)</small></th>
          <th class="sortable" data-sort="new">æ–°é«˜/æ–°ä½</th>
          <th class="sortable" data-sort="change">æ¼²è·Œå¹…(%)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="7" style="text-align: center; color: #666;">è«‹é¸æ“‡ JSON æª”æ¡ˆè¼‰å…¥è³‡æ–™</td>
        </tr>
      </tbody>
    </table>
  </div>

<script>
let highData = [], lowData = [];
let isHighDataLoaded = false, isLowDataLoaded = false;
let currentSort = { column: 'date', direction: 'desc' }; // é è¨­æ’åº

// æª”æ¡ˆè®€å–è™•ç†
document.getElementById('highFileInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        highData = JSON.parse(e.target.result);
        isHighDataLoaded = true;
        console.log('å‰µæ–°é«˜è³‡æ–™è¼‰å…¥æˆåŠŸ:', highData.length, 'ç­†è¨˜éŒ„');
        updateStatus();
        if (document.getElementById('typeSelect').value === 'high') {
          filter();
        }
      } catch (error) {
        alert('è¼‰å…¥å‰µæ–°é«˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
      }
    };
    reader.readAsText(file);
  }
});

document.getElementById('lowFileInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        lowData = JSON.parse(e.target.result);
        isLowDataLoaded = true;
        console.log('å‰µæ–°ä½è³‡æ–™è¼‰å…¥æˆåŠŸ:', lowData.length, 'ç­†è¨˜éŒ„');
        updateStatus();
        if (document.getElementById('typeSelect').value === 'low') {
          filter();
        }
      } catch (error) {
        alert('è¼‰å…¥å‰µæ–°ä½è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
      }
    };
    reader.readAsText(file);
  }
});

// æ›´æ–°è¡¨æ ¼æ¨™é¡Œ
function updateTableHeaders(type) {
  const basePriceHeader = document.getElementById('basePriceHeader');
  if (type === 'high') {
    basePriceHeader.innerHTML = 'å€é–“æœ€é«˜åƒ¹<br><small>(2025/04/07-05/25)</small>';
  } else {
    basePriceHeader.innerHTML = 'å€é–“æœ€ä½åƒ¹<br><small>(2025/04/07-05/25)</small>';
  }
}

// æ›´æ–°ç‹€æ…‹è³‡è¨Š
function updateStatus() {
  const highLoaded = isHighDataLoaded ? `âœ… å‰µæ–°é«˜ (${highData.length} ç­†)` : 'âŒ å‰µæ–°é«˜';
  const lowLoaded = isLowDataLoaded ? `âœ… å‰µæ–°ä½ (${lowData.length} ç­†)` : 'âŒ å‰µæ–°ä½';
  
  if (!isHighDataLoaded && !isLowDataLoaded) {
    document.getElementById('stats').textContent = 'è«‹è¼‰å…¥è³‡æ–™æª”æ¡ˆ';
  } else {
    document.getElementById('stats').textContent = `è³‡æ–™ç‹€æ…‹: ${highLoaded} | ${lowLoaded}`;
  }
}

// è¨ˆç®—æ¼²è·Œå¹…
function calculateChangePercent(close, base) {
  const closePrice = parseFloat(close);
  const basePrice = parseFloat(base);
  if (isNaN(closePrice) || isNaN(basePrice) || basePrice === 0) return 'N/A';
  const change = ((closePrice - basePrice) / basePrice * 100);
  return change.toFixed(2);
}

// è§£æåƒ¹æ ¼ï¼ˆè™•ç†å¯èƒ½çš„å­—ä¸²æ ¼å¼ï¼‰
function parsePrice(price) {
  const parsed = parseFloat(price);
  return isNaN(parsed) ? '0.00' : parsed.toFixed(2);
}

// è¡¨æ ¼æ¨™é¡Œé»æ“Šæ’åº
function setupTableSorting() {
  const headers = document.querySelectorAll('th.sortable');
  headers.forEach(header => {
    header.addEventListener('click', function() {
      const sortColumn = this.getAttribute('data-sort');
      
      // åˆ‡æ›æ’åºæ–¹å‘
      if (currentSort.column === sortColumn) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = sortColumn;
        currentSort.direction = 'desc'; // æ–°æ¬„ä½é è¨­é™åº
      }
      
      // æ›´æ–°è¦–è¦ºæŒ‡ç¤ºå™¨
      updateSortIndicators();
      
      // é‡æ–°ç¯©é¸å’Œæ’åº
      filter();
    });
  });
}

// æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
function updateSortIndicators() {
  const headers = document.querySelectorAll('th.sortable');
  headers.forEach(header => {
    header.classList.remove('sort-asc', 'sort-desc');
    const sortColumn = header.getAttribute('data-sort');
    if (sortColumn === currentSort.column) {
      header.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
    }
  });
}

// æ–°çš„æ’åºåŠŸèƒ½
function sortData(data, type) {
  const sortedData = [...data]; // å»ºç«‹å‰¯æœ¬é¿å…ä¿®æ”¹åŸå§‹è³‡æ–™
  
  return sortedData.sort((a, b) => {
    let valueA, valueB;
    
    switch (currentSort.column) {
      case 'code':
        valueA = a.code;
        valueB = b.code;
        break;
      case 'name':
        valueA = a.name;
        valueB = b.name;
        break;
      case 'date':
        valueA = new Date(a.date);
        valueB = new Date(b.date);
        break;
      case 'close':
        valueA = parseFloat(a.close);
        valueB = parseFloat(b.close);
        break;
      case 'base':
        valueA = parseFloat(type === 'high' ? a.base_high : a.base_low);
        valueB = parseFloat(type === 'high' ? b.base_high : b.base_low);
        break;
      case 'new':
        valueA = parseFloat(type === 'high' ? a.new_high : a.new_low);
        valueB = parseFloat(type === 'high' ? b.new_high : b.new_low);
        break;
      case 'change':
        const baseA = type === 'high' ? a.base_high : a.base_low;
        const newA = type === 'high' ? a.new_high : a.new_low;
        const baseB = type === 'high' ? b.base_high : b.base_low;
        const newB = type === 'high' ? b.new_high : b.new_low;
        valueA = parseFloat(calculateChangePercent(newA, baseA)) || -999;
        valueB = parseFloat(calculateChangePercent(newB, baseB)) || -999;
        break;
      default:
        return 0;
    }
    
    // è™•ç†å­—ä¸²æ¯”è¼ƒ
    if (typeof valueA === 'string' && typeof valueB === 'string') {
      const comparison = valueA.localeCompare(valueB);
      return currentSort.direction === 'asc' ? comparison : -comparison;
    }
    
    // è™•ç†æ•¸å­—å’Œæ—¥æœŸæ¯”è¼ƒ
    if (valueA < valueB) {
      return currentSort.direction === 'asc' ? -1 : 1;
    }
    if (valueA > valueB) {
      return currentSort.direction === 'asc' ? 1 : -1;
    }
    return 0;
  });
}

// ç¯©é¸å’Œé¡¯ç¤ºè³‡æ–™
function filter() {
  const date = document.getElementById('dateInput').value;
  const type = document.getElementById('typeSelect').value;
  const stockSearch = document.getElementById('stockInput').value.toLowerCase().trim();
  
  // æ›´æ–°è¡¨æ ¼æ¨™é¡Œ
  updateTableHeaders(type);
  
  // é¸æ“‡è³‡æ–™ä¾†æº
  let data = [];
  if (type === 'high' && isHighDataLoaded) {
    data = highData;
  } else if (type === 'low' && isLowDataLoaded) {
    data = lowData;
  }
  
  if (data.length === 0) {
    const tbody = document.querySelector('#resultTable tbody');
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">è«‹è¼‰å…¥å°æ‡‰çš„è³‡æ–™æª”æ¡ˆ</td></tr>';
    updateFilterStats([], type, date, stockSearch);
    return;
  }
  
  // å¥—ç”¨ç¯©é¸
  let filteredData = data.filter(item => {
    // æ—¥æœŸç¯©é¸
    const dateMatch = !date || item.date === date;
    
    // è‚¡ç¥¨ä»£è™Ÿ/åç¨±ç¯©é¸
    const stockMatch = !stockSearch || 
                      item.code.toLowerCase().includes(stockSearch) ||
                      item.name.toLowerCase().includes(stockSearch);
    
    return dateMatch && stockMatch;
  });
  
  // å¥—ç”¨æ’åº
  filteredData = sortData(filteredData, type);
  
  // æ›´æ–°çµ±è¨ˆè³‡è¨Š
  updateFilterStats(filteredData, type, date, stockSearch);
  
  // æ›´æ–°è¡¨æ ¼
  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = '';
  
  if (filteredData.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="7" style="text-align: center; color: #666;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td>';
    tbody.appendChild(tr);
    return;
  }
  
  for (const item of filteredData) {
    const tr = document.createElement('tr');
    tr.className = type === 'high' ? 'high-row' : 'low-row';
    
    const basePrice = type === 'high' ? item.base_high : item.base_low;
    const newPrice = type === 'high' ? item.new_high : item.new_low;
    const changePercent = calculateChangePercent(newPrice, basePrice);
      tr.innerHTML = `
      <td style="font-weight: bold;">${item.code}</td>
      <td>${item.name}</td>
      <td title="å‰µæ–°${type === 'high' ? 'é«˜' : 'ä½'}ç™¼ç”Ÿçš„æ—¥æœŸ">${item.date}</td>
      <td style="text-align: right;" title="å‰µæ–°${type === 'high' ? 'é«˜' : 'ä½'}ç•¶æ—¥çš„æ”¶ç›¤åƒ¹">$${parseFloat(item.close).toFixed(2)}</td>
      <td style="text-align: right;" title="åŸºæº–æœŸé–“(2025/04/07-05/25)çš„${type === 'high' ? 'æœ€é«˜' : 'æœ€ä½'}åƒ¹">$${parseFloat(basePrice).toFixed(2)}</td>
      <td style="text-align: right; font-weight: bold; color: ${type === 'high' ? '#28a745' : '#dc3545'};" title="å‰µæ–°${type === 'high' ? 'é«˜' : 'ä½'}ç•¶æ—¥çš„${type === 'high' ? 'æœ€é«˜' : 'æœ€ä½'}åƒ¹">
        $${parseFloat(newPrice).toFixed(2)}
      </td>
      <td style="text-align: right; font-weight: bold; color: ${changePercent !== 'N/A' && parseFloat(changePercent) > 0 ? '#28a745' : '#dc3545'};" title="ç›¸å°æ–¼åŸºæº–åƒ¹çš„æ¼²è·Œå¹…">
        ${changePercent !== 'N/A' ? (parseFloat(changePercent) > 0 ? '+' : '') + changePercent + '%' : 'N/A'}
      </td>
    `;
    tbody.appendChild(tr);
  }
}

// æ›´æ–°ç¯©é¸çµ±è¨ˆè³‡è¨Š
function updateFilterStats(data, type, dateFilter, stockFilter) {
  const totalCount = data.length;
  const typeText = type === 'high' ? 'å‰µæ–°é«˜' : 'å‰µæ–°ä½';
  
  let statsText = `é¡¯ç¤º ${totalCount} ç­† ${typeText} è¨˜éŒ„`;
  
  if (dateFilter) {
    statsText += ` (å‰µæ–°æ—¥æœŸ: ${dateFilter})`;
  }
  
  if (stockFilter) {
    statsText += ` (æœå°‹: "${stockFilter}")`;
  }
  
  // é¡¯ç¤ºç•¶å‰æ’åºæ–¹å¼
  const sortMap = {
    'code': 'ä¾è‚¡ç¥¨ä»£è™Ÿ',
    'name': 'ä¾è‚¡ç¥¨åç¨±',
    'date': 'ä¾å‰µæ–°æ—¥æœŸ',
    'close': 'ä¾æ”¶ç›¤åƒ¹',
    'base': 'ä¾åŸºæº–åƒ¹',
    'new': 'ä¾æ–°é«˜/æ–°ä½',
    'change': 'ä¾æ¼²è·Œå¹…'
  };
  
  if (currentSort.column && sortMap[currentSort.column]) {
    const direction = currentSort.direction === 'asc' ? 'å‡åº' : 'é™åº';
    statsText += ` | æ’åº: ${sortMap[currentSort.column]} (${direction})`;
  }
  
  // è¨ˆç®—æ—¥æœŸåˆ†å¸ƒ
  if (totalCount > 0) {
    const dateGroups = {};
    data.forEach(item => {
      dateGroups[item.date] = (dateGroups[item.date] || 0) + 1;
    });
    
    const dateCount = Object.keys(dateGroups).length;
    if (dateCount > 1) {
      statsText += ` | æ¶µè“‹ ${dateCount} å€‹äº¤æ˜“æ—¥`;
    }
    
    // é¡¯ç¤ºæ—¥æœŸç¯„åœ
    const dates = Object.keys(dateGroups).sort();
    if (dates.length > 0) {
      statsText += ` (${dates[0]} ~ ${dates[dates.length - 1]})`;
    }
  }
  
  document.getElementById('stats').textContent = statsText;
}

// æ¸…é™¤æ‰€æœ‰ç¯©é¸
function clearFilters() {
  document.getElementById('dateInput').value = '';
  document.getElementById('stockInput').value = '';
  // é‡è¨­æ’åºç‚ºé è¨­å€¼
  currentSort = { column: 'date', direction: 'desc' };
  updateSortIndicators();
  filter();
}

// äº‹ä»¶ç›£è½å™¨
document.getElementById('dateInput').addEventListener('change', filter);
document.getElementById('typeSelect').addEventListener('change', filter);
document.getElementById('stockInput').addEventListener('input', filter);

// åˆå§‹åŒ–
updateStatus();
updateTableHeaders('high'); // åˆå§‹åŒ–ç‚ºå‰µæ–°é«˜æ¨¡å¼
setupTableSorting(); // è¨­å®šè¡¨æ ¼æ’åºåŠŸèƒ½
updateSortIndicators(); // è¨­å®šåˆå§‹æ’åºæŒ‡ç¤ºå™¨
</script>
</body>
</html>
